* Installation guide for cloudlab machines

** WITH SUDO 

#+BEGIN_SRC

sudo apt update -y
sudo apt-get install -y autoconf automake libtool pkg-config
sudo apt install -y make cmake g++ libaio-dev libgoogle-perftools-dev clang-format libboost-all-dev libmkl-full-dev libjemalloc-dev


mkdir ~/workspace


cd ~/workspace
sudo apt install libssl-dev
wget https://github.com/Kitware/CMake/releases/download/v3.31.0/cmake-3.31.0.tar.gz
tar -xvzf cmake-3.31.0.tar.gz
cd cmake-3.31.0
./bootstrap
make -j
sudo make install




cd ~/workspace
git clone https://github.com/zeromq/libzmq/
cd libzmq
./autogen.sh
./configure --prefix=/usr/local --enable-drafts
make -j
sudo make install
sudo ldconfig


cd ~/workspace
git clone https://github.com/cmuparlay/parlaylib
cd parlaylib
mkdir build && cd build
cmake ..
sudo cmake --build . --target install



sudo apt-get install nlohmann-json3-dev


cd ~/workspace
git clone https://github.com/catchorg/Catch2.git
cd Catch2
cmake -B build -S . -DBUILD_TESTING=OFF
sudo cmake --build build/ -j --target install



cd ~/workspace
git clone git@github.com:namanhboi/rdma_anns.git
cd ~/workspace/rdma_anns
git submodule update --init --recursive --remote


cd ~/workspace/rdma_anns/extern/liburing
./configure
make -j



cd ~/workspace/rdma_anns/extern/gp-ann
git submodule update --init --recursive
sudo apt-get install libsparsehash-dev




cd ~/workspace/rdma_anns
git clone https://github.com/gabime/spdlog.git
cd spdlog && mkdir build && cd build
cmake .. 
sudo cmake --build . --target install



cd ~/workspace/rdma_anns
cmake -S. -B build -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DTEST_UDL2=OFF -DTEST_UDL1=OFF -DDISK_FS_DISKANN_WRAPPER=OFF -DDISK_FS_DISTRIBUTED=ON -DDISK_KV=OFF -DIN_MEM=OFF -DPQ_KV=OFF -DPQ_FS=ON -DDATA_TYPE=uint8 -DTEST_COMPUTE_PIPELINE=OFF -DBALANCE_ALL=OFF -DCMAKE_BUILD_TYPE=RELEASE



cmake --build build/ -j

cd ~/
git clone https://github.com/harsha-simhadri/big-ann-benchmarks
cd ~/big-ann-benchmarks
sudo apt install -y python3-pip
pip install -r requirements_py3.10.txt
python create_dataset.py --dataset bigann-10M



#+END_SRC


cmake installation

#+BEGIN_SRC
cd ~/workspace
sudo apt install libssl-dev
wget https://github.com/Kitware/CMake/releases/download/v3.31.0/cmake-3.31.0.tar.gz
tar -xvzf cmake-3.31.0.tar.gz
cd cmake-3.31.0
./bootstrap
make -j
sudo make install

#+END_SRC




** Without sudo
.bashrc
#+BEGIN_SRC
source ~/.local/intel-mkl/setvars.sh

# Library paths (runtime)
export LD_LIBRARY_PATH="$HOME/.local/lib64:$HOME/.local/lib:$LD_LIBRARY_PATH"

# Build-time library paths
export LIBRARY_PATH="$HOME/.local/lib64:$HOME/.local/lib"

# Include paths
export C_INCLUDE_PATH="$HOME/.local/include"
export CPLUS_INCLUDE_PATH="$HOME/.local/include"

# Package config
export PKG_CONFIG_PATH="$HOME/.local/lib/pkgconfig:$HOME/.local/lib64/pkgconfig"

# Binaries
export PATH="$HOME/.local/bin:$PATH"

# Aliases
if ! pgrep -u "$USER" emacs > /dev/null; then
    emacs --daemon &
fi
alias ec='emacsclient -nw'
#+END_SRC


#+BEGIN_SRC
mkdir ~/workspace
cd ~/workspace
wget https://pagure.io/libaio/archive/libaio-0.3.113/libaio-libaio-0.3.113.tar.gz
tar -xzf libaio-libaio-0.3.113.tar.gz
cd libaio-libaio-0.3.113
make prefix=$HOME/.local install

#+END_SRC
#+BEGIN_SRC
cd ~/workspace
git clone https://github.com/zeromq/libzmq/
cd libzmq
./autogen.sh
./configure --prefix=$HOME/.local --enable-drafts
make -j
make install
#+END_SRC
#+BEGIN_SRC
cd ~/workspace
git clone https://github.com/nlohmann/json
cd json
mkdir build && cd build
cmake .. -DCMAKE_INSTALL_PREFIX:PATH=$HOME/.local -DJSON_BuildTests=Off
cmake --build . --target install

#+END_SRC

#+BEGIN_SRC
cd ~/workspace
git clone https://github.com/catchorg/Catch2.git
cd Catch2
cmake -B build -S . -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX=$HOME/.local
cmake --build build/ -j --target install
#+END_SRC

# cd ~/workspace/rdma_anns/extern/liburing
# ./configure --prefix=$HOME/.local
# make -j$(nproc)
# make install

#+BEGIN_SRC
# Download gperftools (which provides tcmalloc)
cd ~/workspace
wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.15/gperftools-2.15.tar.gz
tar -xzf gperftools-2.15.tar.gz
cd gperftools-2.15

# Configure and build
./configure --prefix=$HOME/.local
make -j$(nproc)
make install
#+END_SRC

#+BEGIN_SRC
cd ~/workspace
git clone https://github.com/boostorg/boost.git -b boost-1.85.0 boost_1_85_0 --depth 1
cd boost_1_85_0
git submodule update --depth 1 --init --recursive


mkdir __build
cd __build
cmake .. -DCMAKE_INSTALL_PREFIX:PATH=$HOME/.local
cmake --build .
cmake --build . --target install

#+END_SRC


install libmkl
#+BEGIN_SRC
cd ~/workspace
wget https://registrationcenter-download.intel.com/akdlm/IRC_NAS/47c7d946-fca1-441a-b0df-b094e3f045ea/intel-onemkl-2025.2.0.629_offline.sh

sh ./intel-onemkl-2025.2.0.629_offline.sh -a --silent --cli --eula accept --install-dir $HOME/.local/intel-mkl
# Navigate to the MKL lib directory
cd ~/.local/intel-mkl/mkl/2025.2/lib
# Create the symlink that DiskANN expects
ln -sf libmkl_core.so libmkl_def.so


cd $HOME/.local/intel-mkl/mkl/2025.2/include
ln -s mkl_cblas.h cblas.h

#+END_SRC

install clang format
#+BEGIN_SRC
pip install --user clang-format
which clang-format
#+END_SRC



#+BEGIN_SRC
cd ~/workspace
git clone https://github.com/cmuparlay/parlaylib
cd parlaylib
mkdir build && cd build
cmake .. -DCMAKE_INSTALL_PREFIX:PATH=$HOME/.local
cmake --build . --target install
#+END_SRC



#+BEGIN_SRC
cd ~/workspace
git clone https://github.com/catchorg/Catch2.git
cd Catch2
cmake -B build -S . -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX:PATH=$HOME/.local
cmake --build build/ -j --target install
#+END_SRC


#+BEGIN_SRC
cd ~/workspace
git clone git@github.com:namanhboi/rdma_anns.git
cd ~/workspace/rdma_anns
git submodule update --init --recursive --remote

cd ~/workspace/rdma_anns/extern/liburing
./configure
make -j


cd ~/workspace/rdma_anns
git clone https://github.com/gabime/spdlog.git
cd spdlog && mkdir build && cd build
cmake .. -DCMAKE_INSTALL_PREFIX:PATH=$HOME/.local
cmake --build . -j --target install


cmake -S. -B build -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DTEST_UDL2=OFF -DTEST_UDL1=OFF -DDISK_FS_DISKANN_WRAPPER=OFF -DDISK_FS_DISTRIBUTED=ON -DDISK_KV=OFF -DIN_MEM=OFF -DPQ_KV=OFF -DPQ_FS=ON -DDATA_TYPE=uint8 -DTEST_COMPUTE_PIPELINE=OFF -DBALANCE_ALL=OFF -DCMAKE_BUILD_TYPE=RELEASE -DMKL_ROOT=$MKLROOT   -DCMAKE_CXX_FLAGS="-I$HOME/.local/intel-mkl/mkl/2025.2/include"

cmake --build build -j
#+END_SRC




** scp the ssh keys
#+BEGIN_SRC
./scp_ssh.sh
#+END_SRC
* Making clusters

** Build main disk index


building the 100m bigann index with 32 bytes per vector for pq.
#+BEGIN_SRC
cd ~/workspace/rdma_anns
./build/src/state_send/build_disk_index uint8 /users/namanh/big-ann-benchmarks/data/bigann/base.1B.u8bin.crop_nb_100000000 /users/namanh/big-ann-benchmarks/data/bigann/pipeann_100M 64 128 3.3 130 56 l2 0
#+END_SRC


#+BEGIN_SRC
cd ~/workspace/rdma_anns
./build/src/state_send/build_disk_index float /users/namanh/big-ann-benchmarks/data/deep1b/base.1B.fbin.crop_nb_100000000 /mydata/local/anngraphs/deep1b 64 128 3.3 130 56 l2 0
#+END_SRC


** Create indices for scatter and gather
#+BEGIN_SRC

cd ~/workspace/rdma_anns
./build/src/state_send/create_scatter_gather_indices uint8 /mydata/local/anngraphs/bigann/100M/base.1B.u8bin.crop_nb_100000000 /mydata/local/anngraphs/bigann/100M/pipeann_100M 32 64 1.5 128 153 l2 0 3
#+END_SRC



** Create indices for statesend
#+BEGIN_SRC
./build/src/state_send/create_state_send_indices uint8 /mydata/local/anngraphs/bigann/100M/base.1B.u8bin.crop_nb_100000000 /mydata/local/anngraphs/bigann/100M/pipeann_100M l2 2 /mydata/local/anngraphs/bigann/100M/global_partitions_2/pipeann_100M 0 32 64 50
#+END_SRC

** Create fixed num chunks pq data for clusters:
#+BEGIN_SRC
./build/src/state_send/create_pq_data uint8 /mydata/local/anngraphs/bigann/100M/clusters_2/pipeann_100M_cluster0.bin /mydata/local/anngraphs/bigann/100M/clusters_2/pipeann_100M_cluster0 l2 32
#+END_SRC

** Create overlapping partition loc files
#+BEGIN_SRC
$HOME/workspace/rdma_anns/build/src/state_send/create_overlap_partition_loc_files ~/big-ann-benchmarks/data/bigann/10M/base.1B.u8bin.crop_nb_10000000 uint8 2 0.2 ~/big-ann-benchmarks/data/bigann/10M/global_overlap_partitions_2/pipeann_10M
#+END_SRC


** Create bin file for a partition
#+BEGIN_SRC
cd ~/workspace/rdma_anns
./build/src/state_send/create_base_file_from_loc_file uint8 /mydata/local/anngraphs/bigann/1B/base.1B.u8bin /mydata/local/anngraphs/bigann/1B/global_partitions_5/pipeann_1B_partition0_ids_uint32.bin /mydata/local/anngraphs/bigann/1B/global_partitions_5/pipeann_1B_partition0.bin

#+END_SRC


** Create graph file for a global partition
#+BEGIN_SRC
cd ~/workspace/rdma_anns
./build/src/state_send/convert_parlayann_graph_file /mydata/local/anngraphs/bigann/1B/vamana_64_128_1.2 /mydata/local/anngraphs/bigann/1B/global_partitions_10/pipeann_1B_partition0_ids_uint32.bin /mydata/local/anngraphs/bigann/1B/global_partitions_10/pipeann_1B_partition0_graph
#+END_SRC

** Create in mem index
#+BEGIN_SRC
cd ~/workspace/rdma_anns
./build/src/state_send/gen_random_slice uint8 /ssd2/ben/bigann/base.1B.u8bin /ssd2/ben/bigann/pipeann_1B_SAMPLE_RATE_0.01 0.01

./build/src/state_send/build_memory_index uint8 /mydata/local/anngraphs/bigann/1B/clusters_10/pipeann_1B_cluster5_SAMPLE_RATE_0.01_data.bin /mydata/local/anngraphs/bigann/1B/clusters_10/pipeann_1B_cluster5_SAMPLE_RATE_0.01_ids.bin 32 64 1.2 /mydata/local/anngraphs/bigann/1B/clusters_10/pipeann_1B_cluster5_mem.index 56 l2

#+END_SRC

** Create disk index from bin file and graph file
#+BEGIN_SRC
./build/src/state_send/build_disk_index_from_bin_graph uint8 /mydata/local/anngraphs/bigann/1B/global_partitions_10/pipeann_1B_partition5.bin /mydata/local/anngraphs/bigann/1B/global_partitions_10/pipeann_1B_partition5_graph /mydata/local/anngraphs/bigann/1B/global_partitions_10/pipeann_1B_partition5_disk.index

#+END_SRC

** Create partition loc files and partition assignment file
#+BEGIN_SRC
./build/src/state_send/create_partition_loc_files uint8 /ssd2/ben/bigann/base.1B.u8bin 10 /ssd2/ben/bigann/global_partitions_10/pipeann_1B


#+END_SRC
* Cloudlab setup

** nfs
#+BEGIN_SRC
# Update package list
sudo apt update

# Install NFS server
sudo apt install -y nfs-kernel-server

# Verify it installed
dpkg -l | grep nfs

# Check if the service exists now
sudo systemctl status nfs-kernel-server


# Create the exports file
sudo bash -c 'echo "/nfs *(rw,sync,no_subtree_check,no_root_squash)" > /etc/exports'

# View it to confirm
cat /etc/exports

# Export the share
sudo exportfs -ra

# Start the service
sudo systemctl start nfs-kernel-server
sudo systemctl enable nfs-kernel-server

# Verify it's running
sudo systemctl status nfs-kernel-server

# Check exports
sudo exportfs -v
#+END_SRC

** client
#+BEGIN_SRC
cd /
sudo mkdir /nfs

# Try mounting again
sudo mount -t nfs nfs:/nfs /nfs

# Check if it worked
df -h | grep nfs
ls -la /nfs
#+END_SRC

** Expand local storage
#+BEGIN_SRC
sudo mkdir /mydata
sudo /usr/local/etc/emulab/mkextrafs.pl -f /mydata
sudo chown -R namanh:parlayann-PG0 /mydata
mkdir -p /mydata/local/anngraphs/bigann/100M
mkdir -p /mydata/local/anngraphs/bigann/1B
mkdir -p /mydata/local/anngraphs/deep1b/100M
mkdir -p /mydata/local/anngraphs/deep1b/1B

#+END_SRC

** Copy data from nfs

#+BEGIN_SRC
mkdir -p /mydata/local/anngraphs/bigann/100M/
cp /nfs/anngraphs/bigann/100M/base.1B.u8bin.crop_nb_100000000 /mydata/local/anngraphs/bigann/100M/
cp /nfs/anngraphs/bigann/100M/bigann-100M /mydata/local/anngraphs/bigann/100M/
cp /nfs/anngraphs/bigann/100M/pipeann_100M_* /mydata/local/anngraphs/bigann/100M/
cp /nfs/anngraphs/bigann/100M/query.public.10K.u8bin /mydata/local/anngraphs/bigann/100M/


mkdir -p /mydata/local/anngraphs/bigann/100M
mkdir -p /mydata/local/anngraphs/bigann/1B
mkdir -p /mydata/local/anngraphs/deep1b/100M
mkdir -p /mydata/local/anngraphs/deep1b/1B
cd /mydata/local/anngraphs/bigann/1B/
cp /nfs/anngraphs/bigann/1B/{base.1B.u8bin,vamana_64_128_1.2} .







#+END_SRC

* Proxy jump for file transfer
#+BEGIN_SRC
scp -o ProxyJump=user@server1 user@server2:/path/to/bigfile user@server1:/path/to/destination
#+END_SRC


* Running experiments
#+BEGIN_SRC




#+END_SRc
